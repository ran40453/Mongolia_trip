<script>
/* -------------------------------------------------------
   MONGOLIA TRIP APP – Tailwind UI Version
  （安全重寫，不破壞 deployment / 不破壞 include 系統）
--------------------------------------------------------*/
;(function (global) {
  if (!global || !global.document) return;

  // 這段保留，避免 __CW_DEPLOY_TAG 缺失直接跳出
  if (!global.__CW_DEPLOY_TAG) {
    console.warn("[MONGOLIA] __CW_DEPLOY_TAG missing");
    global.__CW_DEPLOY_TAG = "MONGOLIA_TRIP_V1";
  }

  console.log("[MONGOLIA] JS loaded, DEPLOY_TAG =", global.__CW_DEPLOY_TAG);

  /* -------------------------------------------------------
      STATE
  --------------------------------------------------------*/
  const state = {
    tab: "events",
    events: [],
    flights: [],
    landmarks: [],
    packing: [],
    expenses: []
  };

  global.__MONGOLIA_STATE__ = state;


  /* -------------------------------------------------------
      INIT
  --------------------------------------------------------*/
  function initApp() {
    console.log("[MONGOLIA] initApp start");

    const initial = global.INITIAL_DATA || null;
    console.log("[MONGOLIA] INITIAL_DATA =", initial);

    if (initial) {
      state.events = initial.events || [];
      state.flights = initial.flights || [];
      state.landmarks = initial.landmarks || [];
      state.packing = initial.packing || [];
      state.expenses = initial.expenses || [];
    }

    setupTabbar();
    render();

    hideLoading();
  }

  function hideLoading() {
    const loading = document.getElementById("loading");
    if (!loading) return;
    loading.style.opacity = 0;
    setTimeout(() => (loading.style.display = "none"), 400);
  }


  /* -------------------------------------------------------
      TABS
  --------------------------------------------------------*/
  function setupTabbar() {
    const btns = document.querySelectorAll(".tab-btn");
    btns.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.tab;
        console.log("[MONGOLIA] tab =", tab);
        state.tab = tab;

        btns.forEach((b) =>
          b.classList.toggle("text-blue-600", b === btn)
        );
        btns.forEach((b) =>
          b.classList.toggle("text-gray-400", b !== btn)
        );

        render();
      });
    });
  }


  /* -------------------------------------------------------
      MAIN RENDER
  --------------------------------------------------------*/
  function render() {
    const root = document.getElementById("app");
    if (!root) return;

    switch (state.tab) {
      case "events":
        document.getElementById("header-title").textContent = "行程";
        root.innerHTML = renderEventsPage();
        setupEventCardClicks();
        break;

      case "flights":
        document.getElementById("header-title").textContent = "航班";
        root.innerHTML = renderFlightsPage();
        break;

      case "packing":
        document.getElementById("header-title").textContent = "清單";
        root.innerHTML = renderPackingPage();
        setupPackingToggle();
        break;

      case "expenses":
        document.getElementById("header-title").textContent = "記帳";
        root.innerHTML = renderExpensesPage();
        setupExpenseInputs();
        break;
    }
  }


  /* -------------------------------------------------------
      RENDER: EVENTS
  --------------------------------------------------------*/
  function renderEventsPage() {
    const groups = {};

    [...state.events]
      .sort((a, b) =>
        a.dayIndex === b.dayIndex ? a.seq - b.seq : a.dayIndex - b.dayIndex
      )
      .forEach((ev) => {
        const key = ev.dayIndex || 0;
        if (!groups[key]) groups[key] = [];
        groups[key].push(ev);
      });

    let html = "";

    Object.keys(groups)
      .sort((a, b) => a - b)
      .forEach((d) => {
        const day = groups[d];
        const header = day[0].dayTitle || `DAY ${d}`;
        const date = day[0].dateLabel || "";

        html += `
        <section class="mb-8">
          <h2 class="text-lg font-bold mb-2">${header}</h2>
          <p class="text-xs text-gray-500 mb-3">${date}</p>
          <div class="space-y-2">
        `;

        day.forEach((ev) => {
          html += `
            <div class="ev-card p-4 bg-white rounded-xl shadow-sm active:scale-[0.98] transition"
                 data-id="${ev.rowIndex}">
              <div class="text-sm font-medium text-blue-600">${ev.time || ""}</div>
              <div class="font-semibold text-gray-900">${ev.title || ""}</div>
              <div class="text-sm text-gray-500">${ev.place || ""}</div>
              ${ev.note ? `<div class="text-xs text-gray-400 mt-1">${ev.note}</div>` : ""}
            </div>
          `;
        });

        html += `</div></section>`;
      });

    return html || `<p class="text-gray-400 text-center mt-10">尚無行程資料</p>`;
  }

  function setupEventCardClicks() {
    document.querySelectorAll(".ev-card").forEach((card) => {
      card.addEventListener("click", () => {
        const id = Number(card.dataset.id);
        const item = state.events.find((ev) => ev.rowIndex === id);
        if (item) openModal(item);
      });
    });

    setupModalControls();
  }


  /* -------------------------------------------------------
      MODAL
  --------------------------------------------------------*/
  function setupModalControls() {
    const bg = document.getElementById("modal-bg");
    const sheet = document.getElementById("modal-sheet");
    const cancel = document.getElementById("modal-cancel");

    if (!bg || !sheet) return;

    bg.addEventListener("click", closeModal);
    cancel.addEventListener("click", closeModal);
  }

  function openModal(item) {
    document.getElementById("inp-id").value = item.rowIndex;
    document.getElementById("inp-title").value = item.title || "";
    document.getElementById("inp-time").value = item.time || "";
    document.getElementById("inp-place").value = item.place || "";
    document.getElementById("inp-note").value = item.note || "";

    const bg = document.getElementById("modal-bg");
    const sheet = document.getElementById("modal-sheet");
    const modal = document.getElementById("modal");

    modal.classList.remove("hidden");
    setTimeout(() => {
      bg.style.opacity = 1;
      sheet.style.transform = "translateY(0)";
    }, 20);
  }

  function closeModal() {
    const bg = document.getElementById("modal-bg");
    const sheet = document.getElementById("modal-sheet");
    const modal = document.getElementById("modal");

    bg.style.opacity = 0;
    sheet.style.transform = "translateY(100%)";
    setTimeout(() => modal.classList.add("hidden"), 300);
  }


  /* -------------------------------------------------------
      FLIGHTS
  --------------------------------------------------------*/
  function renderFlightsPage() {
    let html = "";
    state.flights.forEach((f) => {
      html += `
        <div class="p-4 mb-3 bg-white rounded-xl shadow-sm">
          <div class="flex justify-between items-center">
            <div>
              <h3 class="font-semibold text-gray-900">${f.segment}</h3>
              <p class="text-xs text-gray-400">${f.date}</p>
            </div>
            <span class="text-blue-600 font-bold">${f.flightNo}</span>
          </div>
          <p class="text-sm mt-2 text-gray-600">${f.time}</p>
          ${f.note ? `<p class="text-xs text-gray-400">${f.note}</p>` : ""}
        </div>
      `;
    });

    return html || `<p class="text-gray-400 text-center mt-10">尚無航班資料</p>`;
  }


  /* -------------------------------------------------------
      PACKING LIST
  --------------------------------------------------------*/
  function renderPackingPage() {
    let html = "";

    state.packing.forEach((p) => {
      const checked =
        String(p.packed).toLowerCase() === "yes" ? "checked" : "";

      html += `
        <div class="p-4 mb-3 bg-white rounded-xl shadow-sm flex justify-between items-center">
          <div>
            <div class="font-semibold">${p.item}</div>
            <div class="text-xs text-gray-400">${p.category}</div>
          </div>
          <input type="checkbox" class="pack-toggle" data-id="${p.rowIndex}" ${checked} />
        </div>
      `;
    });

    return html || `<p class="text-gray-400 text-center mt-10">尚無清單資料</p>`;
  }

  function setupPackingToggle() {
    document.querySelectorAll(".pack-toggle").forEach((chk) => {
      chk.addEventListener("change", () => {
        const row = Number(chk.dataset.id);
        const val = chk.checked ? "yes" : "no";

        google.script.run.updatePackingItem({
          rowIndex: row,
          packed: val
        });
      });
    });
  }


  /* -------------------------------------------------------
      EXPENSES
  --------------------------------------------------------*/
  function renderExpensesPage() {
    let html = `
      <div class="mb-6">
        <h3 class="font-semibold mb-2">新增記帳</h3>
        <div class="space-y-3">
          <input id="exp-date" class="w-full bg-gray-100 p-2 rounded" type="date" />
          <input id="exp-category" class="w-full bg-gray-100 p-2 rounded" placeholder="類別" />
          <input id="exp-desc" class="w-full bg-gray-100 p-2 rounded" placeholder="內容" />
          <input id="exp-amount" class="w-full bg-gray-100 p-2 rounded" type="number" placeholder="金額" />
          <input id="exp-paidby" class="w-full bg-gray-100 p-2 rounded" placeholder="付款人" />
          <button id="exp-add" class="w-full py-2 rounded bg-blue-600 text-white">新增</button>
        </div>
      </div>
      
      <h3 class="font-semibold mb-3">紀錄</h3>
    `;

    state.expenses.forEach((e) => {
      html += `
        <div class="p-4 mb-3 bg-white rounded-xl shadow-sm">
          <div class="flex justify-between items-center">
            <div>
              <p class="font-medium text-gray-900">${e.desc}</p>
              <p class="text-xs text-gray-400">${e.date}</p>
            </div>
            <span class="text-blue-600 font-bold">${e.currency || "CNY"} ${e.amount}</span>
          </div>
        </div>
      `;
    });

    return html;
  }

  function setupExpenseInputs() {
    const btn = document.getElementById("exp-add");
    if (!btn) return;

    btn.addEventListener("click", () => {
      const payload = {
        date: document.getElementById("exp-date").value,
        category: document.getElementById("exp-category").value,
        desc: document.getElementById("exp-desc").value,
        amount: Number(document.getElementById("exp-amount").value),
        currency: "CNY",
        paid_by: document.getElementById("exp-paidby").value,
        memo: ""
      };

      google.script.run.addExpense(payload);

      state.expenses.push(payload);
      render();
    });
  }


  /* -------------------------------------------------------
      READY
  --------------------------------------------------------*/
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initApp);
  } else {
    initApp();
  }
})(typeof globalThis !== "undefined" ? globalThis : this);
</script>